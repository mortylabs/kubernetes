# run the following command to encode your password for DEV :
# echo "YOUR_PASSWORD" -n | base64
---
apiVersion: v1
kind: Secret
metadata:
  name: mqtt-pass
  labels:
    app: mqtt2influx
data:
  # This value is base64-encoded. Do not use this password in production!
  password: YOUR_BASE64_ENCRYPTED_PASSWORD 

---
apiVersion: v1
kind: Secret
metadata:
  name: influx-pass
  labels:
    app: mqtt2influx
data:
  # This value is base64-encoded. Do not use this password in production!
  password: YOUR_BASE64_ENCRYPTED_PASSWORD 


---

# this configmap defines which mqtt topics to subscribe to, and the corresponding influxdb measurement name
apiVersion: v1
kind: ConfigMap
metadata:
  name: cm-mqtt2influx
data:
  topics.txt: |
    "epever/state"                                     "epever"
    'plants/conservatory1/temp/state'                  "conservatory1_temp"
    'plants/conservatory1/baro/state'                  "conservatory1_baro"
    'plants/conservatory1/soil1/state'                 "conservatory1_soil1"
    'greenhouse1_bigsolar/state'                       "greenhouse1_bigsolar"
    'greenhouse2_bigsolar/state'                       "greenhouse2_bigsolar"
    'greenhouse1_minisolar/state'                      "greenhouse1_minisolar"
    'homeassistant/sensor/growtent1_sensor_hum/state'  "growtent1_hum"
    'homeassistant/sensor/growtent1_sensor_temp/state' "growtent1_temp"
    'plants/growtent1/uv_index/state'                  'growtent1'
    'veg1/state'                                       "veg1"
    'plants/growtent1/uv_index/state'                  "growtent1_uvi"
    'hottub/state'                                     "hottub"



---
#replace 192.168.1.15 with the IP address of your load balancer or master node hosting the MQTT broker and InfluxDB
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: mqtt2influx
  name: mqtt2influx
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mqtt2influx
  template:
    metadata:
      labels:
        app: mqtt2influx
    spec:
#      imagePullSecrets:
#      - name: regcred
      containers:
      - image: mortyone/mqtt2influx:latest
        name: mqtt2influx
        imagePullPolicy: IfNotPresent
#        imagePullPolicy: Always
        ports:
          - name: "p8086"
            containerPort: 8086
          - name: "p31883"
            containerPort: 31883
        env:
          - name: LOGGING_LEVEL
            value: "INFO"
          - name: INFLUX_SERVER
            value: "192.168.1.15"
          - name: INFLUX_PORT
            value: "8086"
          - name: INFLUX_DB
            value: "sensors"
          - name: INFLUX_USER
            value: "root"
          - name: INFLUX_PASS
            valueFrom:
              secretKeyRef:
                name: influx-pass
                key: password
          - name: MQTT_SERVER
            value: "192.168.1.15"
          - name: MQTT_PORT
            value: "31883"
          - name: MQTT_USER
            value: "mqtt_user"
          - name: MQTT_PASS
            valueFrom:
              secretKeyRef:
                name: mqtt-pass
                key: password
        volumeMounts:
          - name: config-file
            mountPath: /config
      restartPolicy: Always
      volumes:
        - name: config-file
          configMap:
            name: cm-mqtt2influx

